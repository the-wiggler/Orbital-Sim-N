<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Orbital Simulation Software N</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/litegraph.js/0.7.13/css/litegraph.min.css">
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:0;background:#000;overflow:hidden;color:#fff}
        canvas.emscripten{position:absolute;top:0;left:0;width:100%;height:100%;border:0;background:#000;display:block;outline:0}
        #overlay-top,#info-text{position:absolute;top:15px;z-index:10;display:flex;align-items:center;background:rgba(0,0,0,.5);padding:5px 15px;border-radius:20px;transition:opacity .5s}
        #overlay-top{left:50%;transform:translateX(-50%);pointer-events:none}
        #info-text{right:15px;pointer-events:auto}
        #info-text a{color:#bdd72e;text-decoration:none;font-size:14px}
        #info-text a:hover{text-decoration:underline}
        .spinner{height:18px;width:18px;margin-right:10px;display:inline-block;animation:rotation .8s linear infinite;border-left:3px solid rgba(255,255,255,.2);border-right:3px solid rgba(255,255,255,.2);border-bottom:3px solid rgba(255,255,255,.2);border-top:3px solid #bdd72e;border-radius:100%}
        @keyframes rotation{from{transform:rotate(0)}to{transform:rotate(360deg)}}
        #status{font-size:14px;font-weight:700;color:#ccc}
        #json-trigger{position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:20;background:#222;color:#888;padding:5px 20px;border-radius:8px 8px 0 0;cursor:pointer;font-family:"Courier New",monospace;font-weight:700;font-size:18px;border:1px solid #444;border-bottom:0;transition:color .2s,background-color .2s}
        #json-trigger:hover{background:#333;color:#fff}

        /* Modal & Editor */
        #json-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:30;justify-content:center;align-items:flex-end;opacity:0;transition:opacity .3s ease}
        #json-modal.show{opacity:1}
        .editor-container{width:100%;height:50vh;background:linear-gradient(to bottom,#1a1a1a,#0f0f0f);border:1px solid #444;border-bottom:0;border-radius:16px 16px 0 0;box-shadow:0 -10px 40px rgba(0,0,0,.8);display:flex;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(.25,.46,.45,.94);position:relative}
        #json-modal.show .editor-container{transform:translateY(0)}

        .resize-handle{position:absolute;top:0;left:0;right:0;height:8px;cursor:ns-resize;z-index:100;display:flex;align-items:center;justify-content:center}
        .resize-handle::before{content:"";width:40px;height:4px;background:#555;border-radius:2px;transition:background .2s}
        .resize-handle:hover::before,.resize-handle.dragging::before{background:#bdd72e}

        .editor-buttons{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:20px 20px 15px;border-bottom:1px solid #333;background:#1a1a1a;border-radius:16px 16px 0 0}
        .editor-header{font-size:14px;color:#888;font-family:"Courier New",monospace; display:flex; gap:15px; align-items:center;}
        .view-toggle { background:#222; border:1px solid #444; color:#888; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px; }
        .view-toggle.active { background:#bdd72e; color:#000; border-color:#bdd72e; font-weight:bold; }

        .button-group{display:flex;gap:10px}
        .btn{padding:8px 20px;border:0;border-radius:6px;cursor:pointer;font-weight:700;font-size:13px;transition:all .2s}
        .btn-save{background:#bdd72e;color:#000}
        .btn-save:hover{background:#d4f238;transform:translateY(-1px);box-shadow:0 4px 12px rgba(189,215,46,.4)}
        .btn-reload{background:#2e9dd7;color:#fff}
        .btn-reload:hover{background:#38b4f2;transform:translateY(-1px);box-shadow:0 4px 12px rgba(46,157,215,.4)}
        .btn-cancel{background:#333;color:#ccc;border:1px solid #555}
        .btn-cancel:hover{background:#444;color:#fff}

        .editor-content{flex:1;display:flex;overflow:hidden;position:relative;}
        .editor-main{flex:1;position:relative;background:#1e1e1e;}

        .tree-sidebar{width:200px;background:#0a0a0a;border-left:1px solid #333;overflow-y:auto;padding:4px;font-size:11px}
        .tree-sidebar::-webkit-scrollbar{width:8px}
        .tree-sidebar::-webkit-scrollbar-track{background:#0a0a0a}
        .tree-sidebar::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
        .tree-sidebar::-webkit-scrollbar-thumb:hover{background:#555}

        .tree-node{padding:2px 4px;cursor:pointer;font-family:"Courier New",monospace;font-size:11px;line-height:1.3;color:#888;border-radius:3px;margin:1px 0;transition:all .15s;user-select:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .tree-node:hover{background:#1a1a1a;color:#bdd72e}
        .tree-node.active{background:#2a2a2a;color:#bdd72e;font-weight:700}
        .tree-node.collapsed::before,.tree-node.expanded::before,.tree-node.leaf::before{display:inline-block;width:12px;font-size:10px}
        .tree-node.collapsed::before{content:"▸"}
        .tree-node.expanded::before{content:"▾"}
        .tree-node.leaf::before{content:"·";color:#555}

        .tree-children{padding-left:10px}
        .tree-children.hidden{display:none}

        #monaco-editor{width:100%;height:100%;position:absolute;top:0;left:0;}
        #graph-canvas{width:100%;height:100%;position:absolute;top:0;left:0;visibility:hidden;}

        body.resizing,body.resizing *{cursor:ns-resize!important;user-select:none}

        /* LiteGraph Overrides */
        .litegraph .graphcanvas { background-color: #1e1e1e !important; }
    </style>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.13/build/litegraph.js"></script>
    <script>
        console.log("LiteGraph:", window.LiteGraph);
        console.log("LGraph:", window.LGraph, typeof window.LGraph);
        console.log("LGraphCanvas:", window.LGraphCanvas, typeof window.LGraphCanvas);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>
<body>
<div id="overlay-top">
    <div class="spinner" id="spinner"></div>
    <div id="status">Downloading...</div>
</div>
<div id="info-text"><a id="info" href="https://github.com/toastyy-1/Orbital-Sim-N">Click here for instructions</a></div>
<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
<div id="json-trigger" onclick="openEditor()" title="Edit Simulation Data">{ }</div>

<div id="json-modal" onclick="handleBackdrop(event)">
    <div class="editor-container" id="editor-container">
        <div class="resize-handle" id="resize-handle"></div>
        <div class="editor-buttons">
            <div class="editor-header">
                <span id="filename-label">simulation_data.json</span>
                <button class="view-toggle active" id="btn-view-json" onclick="switchView('json')">JSON</button>
                <button class="view-toggle" id="btn-view-graph" onclick="switchView('graph')">Graph</button>
            </div>
            <div class="button-group">
                <button class="btn btn-cancel" onclick="closeEditor()">Cancel</button>
                <button class="btn btn-save" onclick="saveData()">Apply</button>
                <button class="btn btn-reload" onclick="saveAndReload()">Apply & Reload</button>
            </div>
        </div>
        <div class="editor-content">
            <div class="editor-main">
                <div id="monaco-editor"></div>
                <canvas id="graph-canvas"></canvas>
            </div>
            <div class="tree-sidebar" id="tree-sidebar"></div>
        </div>
    </div>
</div>

<script>
    var statusElem=document.getElementById("status"),
        spinnerElem=document.getElementById("spinner"),
        topOverlay=document.getElementById("overlay-top"),
        runtimeInit=!1,monacoInstance=null,graphInstance=null,graphCanvas=null,
        currentView='json', jsonData=null,
        isResizing=!1,startY=0,startHeight=0,
        resizer=document.getElementById("resize-handle"),
        container=document.getElementById("editor-container"),
        modal=document.getElementById("json-modal"),
        FILE_PATH="/simulation_data.json";

    resizer.addEventListener("mousedown",function(e){
        isResizing=!0;startY=e.clientY;startHeight=container.offsetHeight;
        resizer.classList.add("dragging");document.body.classList.add("resizing");e.preventDefault()
    });
    document.addEventListener("mousemove",function(e){
        if(!isResizing)return;
        var delta=startY-e.clientY,
            newH=startHeight+delta,
            minH=window.innerHeight*.2,
            maxH=window.innerHeight*.9;
        if(newH>=minH&&newH<=maxH){
            container.style.height=newH+"px";
            monacoInstance&&monacoInstance.layout();
            if(graphCanvas) graphCanvas.resize();
        }
    });
    document.addEventListener("mouseup",function(){
        if(isResizing){isResizing=!1;resizer.classList.remove("dragging");document.body.classList.remove("resizing")}
    });

    require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"}});
    function initMonaco(){
        require(["vs/editor/editor.main"],function(){
            monacoInstance=monaco.editor.create(document.getElementById("monaco-editor"),{
                value:'{\n  "loading": "Please wait..."\n}',
                language:"json",theme:"vs-dark",automaticLayout:!0,fontSize:12,
                minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",
                folding:!0,bracketPairColorization:{enabled:!0},padding:{top:8,bottom:8}
            });
            var el=document.getElementById("monaco-editor");
            ["keydown","keyup","keypress","mousedown"].forEach(function(ev){
                el.addEventListener(ev,function(e){e.stopPropagation()})
            });
        })
    }

    function initLiteGraph(){
        if(typeof LGraph !== 'function' || typeof LGraphCanvas !== 'function') {
            console.error("LiteGraph constructors missing!", {LGraph: typeof LGraph, LGraphCanvas: typeof LGraphCanvas});
            return;
        }
        var cvs=document.getElementById("graph-canvas");
        cvs.width = container.offsetWidth - 200;
        cvs.height = container.offsetHeight - 50;
        graphInstance = new LGraph();
        graphCanvas = new LGraphCanvas("#graph-canvas", graphInstance);
        graphCanvas.allow_searchbox = false;
        graphCanvas.background_image = null;
        cvs.addEventListener("keydown", function(e) { e.stopPropagation(); });
        cvs.addEventListener("keyup", function(e) { e.stopPropagation(); });
    }

    function jsonToGraph(jsonObj) {
        if (!graphInstance || !jsonObj) return;
        graphInstance.clear();

        let burnCounter = 0;
        let nodeRegistry = {};
        let pendingReferences = [];
        const REF_FIELDS = ["position_relative_to", "burn_target"];

        // Semantic Grouping for Layout & Coloring
        let nodesByGroup = {
            "root": [],
            "bodies": [],
            "spacecraft": [],
            "burns": [],
            "other": []
        };

        // Color Palette (Dark Theme friendly)
        const COLORS = {
            "root": { bgcolor: "#333333", title_color: "#111" },     // Dark Grey
            "bodies": { bgcolor: "#2a4d69", title_color: "#eee" },   // Deep Blue
            "spacecraft": { bgcolor: "#6b4c35", title_color: "#eee" }, // Earthy Brown/Orange
            "burns": { bgcolor: "#8c3b3b", title_color: "#eee" },    // Red/Maroon
            "other": { bgcolor: "#444444", title_color: "#eee" }     // Standard Grey
        };

        // --- Pass 1: Build Nodes ---
        function buildNode(data, preferredTitle, parentNode, connectionSlot, sourceKey) {
            let title = preferredTitle;
            let isBurn = preferredTitle.toLowerCase().includes("burn");
            if (data.name && typeof data.name === 'string') {
                title = data.name;
            } else if (isBurn) {
                burnCounter++;
                title = `Burn #${burnCounter}`;
            }

            var node = new LiteGraph.LGraphNode();
            node.title = title;

            // Add Input 0: PARENT (Hierarchy)
            if (parentNode) node.addInput("Parent", "*");

            var primitives = [];
            var childrenToConnect = [];

            // Determine Group & Color
            let group = "other";
            if (!parentNode) group = "root";
            else if (sourceKey === "bodies") group = "bodies";
            else if (sourceKey === "spacecraft") group = "spacecraft";
            else if (sourceKey === "burns") group = "burns";

            if (COLORS[group]) {
                node.color = COLORS[group].bgcolor;
                node.bgcolor = COLORS[group].bgcolor;
                // node.boxcolor = "#555"; // Optional border
            }

            nodesByGroup[group].push(node);


            Object.keys(data).forEach(function(key) {
                var val = data[key];
                if (key === "name") return;

                if (REF_FIELDS.includes(key)) {
                    node.addInput(key, "reference");
                    pendingReferences.push({ sourceNode: node, slotName: key, targetName: val });
                    return;
                }

                if (val === null || typeof val !== 'object') {
                    primitives.push({ key: key, val: val });
                }
                else if (Array.isArray(val)) {
                    node.addOutput(key, "array");
                    let slotIdx = node.outputs.length - 1;
                    val.forEach((item, idx) => {
                        let childTitle = key.replace(/s$/, "") || "item";
                        childrenToConnect.push({ data: item, slot: slotIdx, title: childTitle, sourceKey: key });
                    });
                }
                else {
                    node.addOutput(key, "object");
                    childrenToConnect.push({ data: val, slot: node.outputs.length - 1, title: key, sourceKey: key });
                }
            });

            // Add Widgets
            primitives.forEach(function(p) {
                var type = typeof p.val === 'number' ? "number" : "string";
                node.addWidget(type, p.key, p.val, function(v) { data[p.key] = v; });
            });

            // Sizing
            const ioCount = Math.max(
                node.inputs ? node.inputs.length : 0,
                node.outputs ? node.outputs.length : 0
            );
            // Height: Header(30) + (Widgets+IO)*24 + Padding(20)
            const contentHeight = 30 + (Math.max(primitives.length, ioCount) * 24) + 20;
            node.size = [280, Math.max(contentHeight, 80)];

            graphInstance.add(node);
            nodeRegistry[title] = node;

            if (parentNode && connectionSlot !== null) {
                parentNode.connect(connectionSlot, node, 0);
            }

            childrenToConnect.forEach(function(child) {
                if (child.data && typeof child.data === 'object') {
                    buildNode(child.data, child.title, node, child.slot, child.sourceKey);
                }
            });
        }

        // Init
        buildNode(jsonObj, "Simulation", null, null, "root");

        // --- Pass 2: References ---
        pendingReferences.forEach(function(ref) {
            var targetNode = nodeRegistry[ref.targetName];
            if (targetNode) {
                let refSlot = -1;
                if (targetNode.outputs) refSlot = targetNode.outputs.findIndex(o => o.name === "Reference");
                if (refSlot === -1) {
                    targetNode.addOutput("Reference", "reference");
                    refSlot = targetNode.outputs.length - 1;
                    targetNode.size[1] += 24;
                }
                var inputSlot = ref.sourceNode.findInputSlot(ref.slotName);
                targetNode.connect(refSlot, ref.sourceNode, inputSlot);
            }
        });

        // --- Pass 3: Column Layout ---
        const COL_WIDTH = 450;
        const ROW_PAD = 40;

        function stackNodes(nodes, colIndex) {
            if (!nodes.length) return;
            let currentY = 100;
            let xPos = 100 + (colIndex * COL_WIDTH);

            nodes.forEach(node => {
                node.pos = [xPos, currentY];
                currentY += node.size[1] + ROW_PAD;
            });
        }

        stackNodes(nodesByGroup["root"], 0);
        stackNodes(nodesByGroup["bodies"], 1);
        stackNodes(nodesByGroup["spacecraft"], 2);
        stackNodes(nodesByGroup["burns"], 3);
        stackNodes(nodesByGroup["other"], 4);

        graphCanvas.setZoomAndPan(0.8, [50, 50]);
    }

    function switchView(view) {
        if(currentView === view) return;

        if(currentView === 'json') {
            try {
                var val = monacoInstance.getValue();
                jsonData = JSON.parse(val);
            } catch(e) {
                alert("Fix JSON errors before switching."); return;
            }
        }

        currentView = view;
        document.getElementById('btn-view-json').classList.toggle('active', view==='json');
        document.getElementById('btn-view-graph').classList.toggle('active', view==='graph');

        if(view === 'graph') {
            document.getElementById('monaco-editor').style.visibility = 'hidden';
            document.getElementById('graph-canvas').style.visibility = 'visible';

            if(!graphInstance) initLiteGraph();
            jsonToGraph(jsonData);
        } else {
            document.getElementById('monaco-editor').style.visibility = 'visible';
            document.getElementById('graph-canvas').style.visibility = 'hidden';
            monacoInstance.setValue(JSON.stringify(jsonData, null, 2));
        }
    }

    function buildTree(obj,path){
        var tree=[];
        if(Array.isArray(obj)){
            obj.forEach(function(item,idx){
                var currPath=path.concat(idx);
                tree.push({label:"["+idx+"]",path:currPath,line:findLine(currPath),
                    children:typeof item==="object"&&item!==null?buildTree(item,currPath):[]})
            })
        }else if(typeof obj==="object"&&obj!==null){
            Object.keys(obj).forEach(function(key){
                var currPath=path.concat(key),val=obj[key],leaf=typeof val!=="object"||val===null;
                tree.push({label:key,path:currPath,line:findLine(currPath),isLeaf:leaf,
                    children:!leaf?buildTree(val,currPath):[]})
            })
        }
        return tree
    }
    function findLine(path){
        if(!monacoInstance)return 1;
        var content=monacoInstance.getValue(),lines=content.split("\n");
        var key=path[path.length-1],searchStr='"'+key+'"',matches=[],i=0;
        for(i=0;i<lines.length;i++) if(lines[i].includes(searchStr)) matches.push(i+1);
        var parentArrayIdx = typeof path[path.length-2]==="number" ? path[path.length-2] : 0;
        return matches[parentArrayIdx] || matches[0] || 1;
    }
    function renderTree(nodes,parent,depth){
        depth=depth||0;
        nodes.forEach(function(node){
            var el=document.createElement("div");
            el.className="tree-node";
            el.style.paddingLeft=(depth*8+4)+"px";
            if(node.children&&node.children.length){
                el.classList.add("collapsed");
                el.textContent=node.label;el.title=node.label;
                var childContainer=document.createElement("div");
                childContainer.className="tree-children hidden";
                el.onclick=function(e){
                    e.stopPropagation();
                    if(el.classList.contains("expanded")){
                        el.classList.remove("expanded");el.classList.add("collapsed");
                        childContainer.classList.add("hidden")
                    }else{
                        el.classList.remove("collapsed");el.classList.add("expanded");
                        childContainer.classList.remove("hidden")
                    }
                };
                parent.appendChild(el);renderTree(node.children,childContainer,depth+1);parent.appendChild(childContainer)
            }else{
                el.classList.add("leaf");el.textContent=node.label;el.title=node.label;
                el.onclick=function(e){
                    e.stopPropagation();
                    jumpToTarget(node);
                    document.querySelectorAll(".tree-node").forEach(function(n){n.classList.remove("active")});
                    el.classList.add("active")
                };
                parent.appendChild(el)
            }
        })
    }
    function jumpToTarget(node){
        if(currentView === 'json') {
            monacoInstance.revealLineInCenter(node.line);
            monacoInstance.setPosition({lineNumber:node.line,column:1});
            monacoInstance.focus();
        } else {
            if(!graphInstance) return;
            var label = node.path[node.path.length-1];
            // Find by Title
            var found = graphInstance._nodes.find(n => n.title.includes(label));
            if(found) {
                graphCanvas.centerOnNode(found);
                graphCanvas.selectNode(found);
            }
        }
    }
    function refreshSidebar(){
        var sb=document.getElementById("tree-sidebar");sb.innerHTML="";
        var source = (currentView==='json' && monacoInstance) ? JSON.parse(monacoInstance.getValue()) : jsonData;
        try{
            renderTree(buildTree(source,[]),sb);
        }catch(e){ sb.innerHTML='<div class="tree-node" style="color:#f84;">Invalid Data</div>'; }
    }
    function loadFile(){
        if(!Module.FS){console.warn("FS missing");return}
        try{
            var content=Module.FS.readFile(FILE_PATH,{encoding:"utf8"});
            try{
                jsonData=JSON.parse(content);
                var fmt=JSON.stringify(jsonData,null,2);
                monacoInstance&&(monacoInstance.setValue(fmt),refreshSidebar())
            }catch(e){
                monacoInstance&&monacoInstance.setValue(content)
            }
        }catch(e){
            monacoInstance&&monacoInstance.setValue('{\n  "error": "File not found"\n}')
        }
    }
    function saveData(){
        if(currentView === 'json') {
            try { jsonData = JSON.parse(monacoInstance.getValue()); } catch(e) { alert("Invalid JSON"); return; }
        }
        try{
            Module.FS.writeFile(FILE_PATH, JSON.stringify(jsonData, null, 2));
            console.log("Saved"); closeEditor();
        }catch(e){ alert("Save error: "+e.message) }
    }
    var Module={
        print:function(t){console.log(t)},
        printErr:function(t){console.error(t)},
        canvas:(function(){
            var c=document.getElementById("canvas");
            c.addEventListener("webglcontextlost",function(e){alert("Context lost");e.preventDefault()},!1);
            return c
        })(),
        onRuntimeInitialized:function(){
            runtimeInit=!0;setTimeout(loadFile,100)
        },
        setStatus:function(t){
            if(!Module.setStatus.last)Module.setStatus.last={time:Date.now(),text:""};
            if(t===Module.setStatus.last.text)return;
            var m=t.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),now=Date.now();
            if(m&&now-Module.setStatus.last.time<30)return;
            Module.setStatus.last.time=now;Module.setStatus.last.text=t;
            if(m){t=m[1];spinnerElem.hidden=!1;topOverlay.style.opacity="1"}
            else if(!t){spinnerElem.style.display="none";setTimeout(function(){if(statusElem.innerHTML==="")topOverlay.style.opacity="0"},3000)}
            statusElem.innerHTML=t
        },
        monitorRunDependencies:function(l){
            Module.setStatus(l?"Preparing... ("+l+")":"All downloads complete.")
        }
    };
    Module.setStatus("Downloading...");
    window.onerror=function(e){Module.setStatus("JS Exception");spinnerElem.style.display="none"};
    initMonaco();
    function openEditor(){
        if(!runtimeInit){alert("Wait loading.");return}
        if(!Module.FS){alert("No FS.");return}
        loadFile();modal.style.display="flex";
        requestAnimationFrame(function(){modal.classList.add("show")});
        setTimeout(function(){
            if(currentView==='json') monacoInstance.focus();
            refreshSidebar();
        },400)
    }
    function closeEditor(){
        modal.classList.remove("show");
        setTimeout(function(){modal.style.display="none";document.getElementById("canvas").focus()},400)
    }
    function handleBackdrop(e){if(e.target===modal)closeEditor()}
    function saveAndReload(){
        saveData();
        console.log("Reloading simulation...");
        var cvs = document.getElementById("canvas");
        cvs.focus();
        setTimeout(function(){
            var cmdString = "preset\nload\nr\n";
            var index = 0;
            function typeChar() {
                if (index >= cmdString.length) return;
                var charStr = cmdString[index];
                var keyCode = charStr.charCodeAt(0);
                if (charStr === '\n') keyCode = 13;
                var down = new KeyboardEvent('keydown', {
                    key: charStr === '\n' ? 'Enter' : charStr,
                    code: charStr === '\n' ? 'Enter' : 'Key' + charStr.toUpperCase(),
                    keyCode: keyCode,
                    which: keyCode,
                    bubbles: true,
                    cancelable: true
                });
                cvs.dispatchEvent(down);
                var press = new KeyboardEvent('keypress', {
                    key: charStr === '\n' ? 'Enter' : charStr,
                    keyCode: keyCode,
                    charCode: keyCode,
                    which: keyCode,
                    bubbles: true,
                    cancelable: true
                });
                cvs.dispatchEvent(press);
                setTimeout(function(){
                    var up = new KeyboardEvent('keyup', {
                        key: charStr === '\n' ? 'Enter' : charStr,
                        code: charStr === '\n' ? 'Enter' : 'Key' + charStr.toUpperCase(),
                        keyCode: keyCode,
                        which: keyCode,
                        bubbles: true,
                        cancelable: true
                    });
                    cvs.dispatchEvent(up);

                    index++;
                    setTimeout(typeChar, 16);
                }, 10);
            }
            typeChar();
        }, 16);
    }
</script>
<script async src="OrbitSimulation.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Orbital Simulation Software N</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/litegraph.js/0.7.13/css/litegraph.min.css">
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:0;background:#000;overflow:hidden;color:#fff; user-select: none;}

        /* Force pointer events on canvas so it can receive clicks */
        canvas.emscripten{position:absolute;top:0;left:0;width:100%;height:100%;border:0;background:#000;display:block;outline:0; pointer-events: auto !important;}

        #overlay-top,#info-text{position:absolute;top:15px;z-index:10;display:flex;align-items:center;background:rgba(0,0,0,.5);padding:5px 15px;border-radius:20px;transition:opacity .5s}
        #overlay-top{left:50%;transform:translateX(-50%);pointer-events:none}
        #info-text{right:15px;pointer-events:auto}
        #info-text a{color:#bdd72e;text-decoration:none;font-size:14px}
        #info-text a:hover{text-decoration:underline}
        .spinner{height:18px;width:18px;margin-right:10px;display:inline-block;animation:rotation .8s linear infinite;border-left:3px solid rgba(255,255,255,.2);border-right:3px solid rgba(255,255,255,.2);border-bottom:3px solid rgba(255,255,255,.2);border-top:3px solid #bdd72e;border-radius:100%}
        @keyframes rotation{from{transform:rotate(0)}to{transform:rotate(360deg)}}
        #status{font-size:14px;font-weight:700;color:#ccc}
        #json-trigger{position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:20;background:#222;color:#888;padding:5px 20px;border-radius:8px 8px 0 0;cursor:pointer;font-family:"Courier New",monospace;font-weight:700;font-size:18px;border:1px solid #444;border-bottom:0;transition:color .2s,background-color .2s}
        #json-trigger:hover{background:#333;color:#fff}

        /* Modal & Editor */
        #json-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:30;justify-content:center;align-items:flex-end;opacity:0;transition:opacity .3s ease}
        #json-modal.show{opacity:1}
        .editor-container{width:100%;height:50vh;background:linear-gradient(to bottom,#1a1a1a,#0f0f0f);border:1px solid #444;border-bottom:0;border-radius:16px 16px 0 0;box-shadow:0 -10px 40px rgba(0,0,0,.8);display:flex;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(.25,.46,.45,.94);position:relative}
        #json-modal.show .editor-container{transform:translateY(0)}

        .resize-handle{position:absolute;top:0;left:0;right:0;height:8px;cursor:ns-resize;z-index:100;display:flex;align-items:center;justify-content:center}
        .resize-handle::before{content:"";width:40px;height:4px;background:#555;border-radius:2px;transition:background .2s}
        .resize-handle:hover::before,.resize-handle.dragging::before{background:#bdd72e}

        .editor-buttons{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:20px 20px 15px;border-bottom:1px solid #333;background:#1a1a1a;border-radius:16px 16px 0 0}
        .editor-header{font-size:14px;color:#888;font-family:"Courier New",monospace; display:flex; gap:15px; align-items:center;}
        .view-toggle { background:#222; border:1px solid #444; color:#888; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px; }
        .view-toggle.active { background:#bdd72e; color:#000; border-color:#bdd72e; font-weight:bold; }

        .button-group{display:flex;gap:10px}
        .btn{padding:8px 20px;border:0;border-radius:6px;cursor:pointer;font-weight:700;font-size:13px;transition:all .2s}
        .btn-save{background:#bdd72e;color:#000}
        .btn-save:hover{background:#d4f238;transform:translateY(-1px);box-shadow:0 4px 12px rgba(189,215,46,.4)}
        .btn-reload{background:#2e9dd7;color:#fff}
        .btn-reload:hover{background:#38b4f2;transform:translateY(-1px);box-shadow:0 4px 12px rgba(46,157,215,.4)}
        .btn-cancel{background:#333;color:#ccc;border:1px solid #555}
        .btn-cancel:hover{background:#444;color:#fff}

        .editor-content{flex:1;display:flex;overflow:hidden;position:relative;}
        .editor-main{flex:1;position:relative;background:#1e1e1e;}

        .tree-sidebar{width:200px;background:#0a0a0a;border-left:1px solid #333;overflow-y:auto;padding:4px;font-size:11px}
        .tree-sidebar::-webkit-scrollbar{width:8px}
        .tree-sidebar::-webkit-scrollbar-track{background:#0a0a0a}
        .tree-sidebar::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
        .tree-sidebar::-webkit-scrollbar-thumb:hover{background:#555}

        .tree-node{padding:2px 4px;cursor:pointer;font-family:"Courier New",monospace;font-size:11px;line-height:1.3;color:#888;border-radius:3px;margin:1px 0;transition:all .15s;user-select:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .tree-node:hover{background:#1a1a1a;color:#bdd72e}
        .tree-node.active{background:#2a2a2a;color:#bdd72e;font-weight:700}
        .tree-node.collapsed::before,.tree-node.expanded::before,.tree-node.leaf::before{display:inline-block;width:12px;font-size:10px}
        .tree-node.collapsed::before{content:"▸"}
        .tree-node.expanded::before{content:"▾"}
        .tree-node.leaf::before{content:"·";color:#555}

        .tree-children{padding-left:10px}
        .tree-children.hidden{display:none}

        #monaco-editor{width:100%;height:100%;position:absolute;top:0;left:0;}
        #graph-canvas{width:100%;height:100%;position:absolute;top:0;left:0;visibility:hidden;}

        body.resizing,body.resizing *{cursor:ns-resize!important;user-select:none}

        .litecontextmenu,
        .litecontextmenu * {
            z-index: 99999 !important;
        }

        #json-modal {
            z-index: 100 !important;
        }

        .editor-container {
            isolation: isolate;
        }
    </style>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.13/build/litegraph.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>
<body>
<div id="overlay-top">
    <div class="spinner" id="spinner"></div>
    <div id="status">Downloading...</div>
</div>
<div id="info-text"><a id="info" href="https://github.com/toastyy-1/Orbital-Sim-N">Click here for instructions</a></div>

<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
<div id="json-trigger" onclick="openEditor()" title="Edit Simulation Data">{ }</div>

<div id="json-modal" onclick="handleBackdrop(event)">
    <div class="editor-container" id="editor-container">
        <div class="resize-handle" id="resize-handle"></div>
        <div class="editor-buttons">
            <div class="editor-header">
                <span id="filename-label">simulation_data.json</span>
                <button class="view-toggle active" id="btn-view-json" onclick="switchView('json')">JSON</button>
                <button class="view-toggle" id="btn-view-graph" onclick="switchView('graph')">Graph</button>
            </div>
            <div class="button-group">
                <button class="btn btn-cancel" onclick="closeEditor()">Cancel</button>
                <button class="btn btn-save" onclick="saveData()">Apply</button>
                <button class="btn btn-reload" onclick="saveAndReload()">Apply & Reload</button>
            </div>
        </div>
        <div class="editor-content">
            <div class="editor-main">
                <div id="monaco-editor"></div>
                <canvas id="graph-canvas"></canvas>
            </div>
            <div class="tree-sidebar" id="tree-sidebar"></div>
        </div>
    </div>
</div>

<script>
    var statusElem=document.getElementById("status"),
        spinnerElem=document.getElementById("spinner"),
        topOverlay=document.getElementById("overlay-top"),
        runtimeInit=!1,monacoInstance=null,graphInstance=null,graphCanvas=null,
        currentView='json', jsonData=null, lastRenderedJsonString = "",
        isResizing=!1,startY=0,startHeight=0,
        resizer=document.getElementById("resize-handle"),
        container=document.getElementById("editor-container"),
        modal=document.getElementById("json-modal"),
        emscriptenCanvas = document.getElementById("canvas"),
        FILE_PATH="/simulation_data.json";

    // --- FOCUS MANAGEMENT ---
    // 1. Force focus on click (Global fallback)
    document.addEventListener('click', function(e){
        // If clicking inside Editor or Trigger, ignore
        if(e.target.closest('#json-modal') || e.target.closest('#json-trigger')) return;
        // Otherwise, assume user wants to play
        if(!modal.classList.contains("show")){
            emscriptenCanvas.focus();
        }
    });

    // 2. Block inputs from reaching game when Editor is open
    ['keydown', 'keyup', 'keypress'].forEach(evt => {
        window.addEventListener(evt, function(e) {
            if (modal.classList.contains("show")) {
                var t = e.target;
                // Allow typing in Inputs
                var isInput = t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.contentEditable === 'true';
                if (!isInput) {
                    // Swallow stray keys to protect Emscripten
                    e.stopImmediatePropagation();
                    e.preventDefault();
                } else {
                    // Let input receive event, but stop propagation to window
                    e.stopPropagation();
                }
            }
        }, true);
    });

    resizer.addEventListener("mousedown",function(e){
        isResizing=!0;startY=e.clientY;startHeight=container.offsetHeight;
        resizer.classList.add("dragging");document.body.classList.add("resizing");e.preventDefault()
    });
    document.addEventListener("mousemove",function(e){
        if(!isResizing)return;
        var delta=startY-e.clientY, newH=startHeight+delta, minH=window.innerHeight*.2, maxH=window.innerHeight*.9;
        if(newH>=minH&&newH<=maxH){
            container.style.height=newH+"px";
            monacoInstance&&monacoInstance.layout();
            if(graphCanvas) graphCanvas.resize();
        }
    });
    document.addEventListener("mouseup",function(){
        if(isResizing){isResizing=!1;resizer.classList.remove("dragging");document.body.classList.remove("resizing")}
    });

    require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"}});
    function initMonaco(){
        require(["vs/editor/editor.main"],function(){
            monacoInstance=monaco.editor.create(document.getElementById("monaco-editor"),{
                value:'{\n  "loading": "Please wait..."\n}',
                language:"json",theme:"vs-dark",automaticLayout:!0,fontSize:12,
                minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",
                folding:!0,bracketPairColorization:{enabled:!0},padding:{top:8,bottom:8}
            });
            // Stop propagation from Monaco to prevent game input
            var el=document.getElementById("monaco-editor");
            ["keydown","keyup","keypress","mousedown"].forEach(function(ev){
                el.addEventListener(ev,function(e){e.stopPropagation()})
            });
        })
    }

    function initLiteGraph(){
        if(typeof LGraph === 'undefined') return;
        var cvs=document.getElementById("graph-canvas");

        // FIX: Use actual parent dimensions instead of hardcoded calculation
        // This ensures 1:1 mapping between mouse coordinates and canvas pixels
        var parent = cvs.parentElement;
        cvs.width = parent.clientWidth;
        cvs.height = parent.clientHeight;

        graphInstance = new LGraph();
        graphCanvas = new LGraphCanvas("#graph-canvas", graphInstance);

        graphCanvas.allow_searchbox = false;

        graphCanvas.getCanvasMenuOptions = function(){
            var options = [];

            options.push({content:"Add Body", callback: function(){ addNode("body"); }});
            options.push({content:"Add Spacecraft", callback: function(){ addNode("spacecraft"); }});
            options.push({content:"Add Burn", callback: function(){ addNode("burn"); }});

            options.push(null); // separator

            options.push({content:"Duplicate Selection", callback: function(){
                    var selected = graphCanvas.selected_nodes || {};
                    var newNodes = [];

                    Object.values(selected).forEach(node => {
                        var data = {};
                        if(node.properties) Object.assign(data, node.properties);
                        if(node.widgets) node.widgets.forEach(w => data[w.name] = w.value);

                        if(node.title && !node.title.startsWith("Burn #")) data.name = node.title + " (Copy)";
                        else if (node.title.startsWith("Burn #")) data.name = null;

                        var sourceKey = node.properties ? node.properties.sourceKey : "other";

                        var newNode = createVisualNode(data, node.title + (sourceKey==="burns"?"":" (Copy)"), null, null, sourceKey);
                        newNode.pos = [node.pos[0] + 50, node.pos[1] + 50];
                        newNodes.push(newNode);
                    });

                    graphCanvas.selectNodes(newNodes);
                }});

            return options;
        };
    }

    function addNode(type) {
        var data = {};
        if (type === "body") {
            data = { name: "New Body", mass: 1e24, radius: 1000, pos_x:0, pos_y:0, pos_z:0, vel_x:0, vel_y:0, vel_z:0, rotational_v:0, attitude_axis_x:0, attitude_axis_y:1, attitude_axis_z:0, attitude_angle:0 };
        } else if (type === "spacecraft") {
            data = { name: "New Craft", position_relative_to: "", pos_x:0, pos_y:0, pos_z:0, vel_x:0, vel_y:0, vel_z:0, dry_mass:1000, fuel_mass:1000, thrust:1000, specific_impulse:300, mass_flow_rate:1, attitude:0, moment_of_inertia:1000, nozzle_gimbal_range:0.1, burns:[] };
        } else if (type === "burn") {
            data = { burn_target: "", burn_type: "tangent", start_time:0, duration:10, heading:0, throttle:1 };
        }
        createVisualNode(data, type === "burn" ? "New Burn" : data.name, null, null, type === "body" ? "bodies" : (type === "spacecraft" ? "spacecraft" : "burns"));
    }

    function createVisualNode(data, title, parentNode, connectionSlot, sourceKey) {
        var node = new LiteGraph.LGraphNode();
        node.title = title;

        if(graphCanvas.graph_mouse) { node.pos = [graphCanvas.graph_mouse[0], graphCanvas.graph_mouse[1]]; }
        else { node.pos = [100, 100]; }

        node.properties = node.properties || {};
        node.properties.sourceKey = sourceKey;

        const COLORS = { "root": "#333", "bodies": "#2a4d69", "spacecraft": "#6b4c35", "burns": "#8c3b3b", "other": "#444" };
        let group = "other";
        if (sourceKey === "root") group = "root";
        else if (sourceKey === "bodies") group = "bodies";
        else if (sourceKey === "spacecraft") group = "spacecraft";
        else if (sourceKey === "burns") group = "burns";
        if (COLORS[group]) { node.color = COLORS[group]; node.bgcolor = COLORS[group]; }

        node.addInput("Parent", "*");

        // FIX: ALWAYS add Reference output for non-burn/root nodes
        if (sourceKey !== "burns" && sourceKey !== "root") {
            node.addOutput("Reference", "reference");
        }

        var primitives = [];
        const REF_FIELDS = ["position_relative_to", "burn_target"];

        Object.keys(data).forEach(function(key) {
            var val = data[key];
            if (key === "name") return;
            if (REF_FIELDS.includes(key)) { node.addInput(key, "reference"); return; }
            if (val === null || typeof val !== 'object') { primitives.push({ key: key, val: val }); }
            else if (Array.isArray(val)) { node.addOutput(key, "array"); }
            else { node.addOutput(key, "object"); }
        });

        // Add Widgets
        primitives.forEach(function(p) {
            var type = typeof p.val === 'number' ? "number" : "string";
            node.addWidget(type, p.key, p.val, function(v) { node.properties[p.key] = v; });
            node.properties[p.key] = p.val;
        });

        const ioCount = Math.max(node.inputs?node.inputs.length:0, node.outputs?node.outputs.length:0);
        node.size = [280, Math.max(30 + (Math.max(primitives.length, ioCount) * 24) + 20, 80)];
        graphInstance.add(node);
        return node;
    }


    function jsonToGraph(jsonObj) {
        if (!graphInstance || !jsonObj) return;
        graphInstance.clear();
        let burnCounter = 0, nodeRegistry = {}, pendingReferences = [];
        const REF_FIELDS = ["position_relative_to", "burn_target"];
        const COLORS = { "root": "#333", "bodies": "#2a4d69", "spacecraft": "#6b4c35", "burns": "#8c3b3b", "other": "#444" };
        let nodesByGroup = { "root":[], "bodies":[], "spacecraft":[], "burns":[], "other":[] };

        function buildNode(data, preferredTitle, parentNode, connectionSlot, sourceKey) {
            let title = preferredTitle;
            let isBurn = preferredTitle.toLowerCase().includes("burn");
            if (data.name && typeof data.name === 'string') title = data.name;
            else if (isBurn) { burnCounter++; title = `Burn #${burnCounter}`; }

            var node = new LiteGraph.LGraphNode();
            node.title = title;
            node.properties = { sourceKey: sourceKey };

            if (parentNode) node.addInput("Parent", "*");

            let group = "other";
            if (!parentNode) group = "root";
            else if (sourceKey === "bodies") group = "bodies";
            else if (sourceKey === "spacecraft") group = "spacecraft";
            else if (sourceKey === "burns") group = "burns";

            if (COLORS[group]) { node.color = COLORS[group]; node.bgcolor = COLORS[group]; }
            nodesByGroup[group].push(node);

            // FIX: ALWAYS add Reference output for non-burn/root nodes
            if (sourceKey !== "burns" && sourceKey !== "root" && sourceKey !== "spacecraft") {
                node.addOutput("Reference", "reference");
            }

            var primitives = [], childrenToConnect = [];
            if(data && typeof data === 'object') {
                Object.keys(data).forEach(function(key) {
                    var val = data[key];
                    if (key === "name") return;
                    if (REF_FIELDS.includes(key)) {
                        node.addInput(key, "reference");
                        if(val && typeof val === 'string' && val.trim() !== "") pendingReferences.push({ sourceNode: node, slotName: key, targetName: val });
                        return;
                    }
                    if (val === null || typeof val !== 'object') { primitives.push({ key: key, val: val }); }
                    else if (Array.isArray(val)) {
                        node.addOutput(key, "array");
                        let slotIdx = node.outputs.length - 1;
                        val.forEach((item) => { childrenToConnect.push({ data: item, slot: slotIdx, title: key.replace(/s$/, "") || "item", sourceKey: key }); });
                    } else {
                        node.addOutput(key, "object");
                        childrenToConnect.push({ data: val, slot: node.outputs.length - 1, title: key, sourceKey: key });
                    }
                });
            }

            // Widgets
            primitives.forEach(p => {
                var type = typeof p.val === 'number' ? "number" : "string";
                node.properties[p.key] = p.val;
                node.addWidget(type, p.key, p.val, function(v) { node.properties[p.key] = v; });
            });

            const ioCount = Math.max(node.inputs?node.inputs.length:0, node.outputs?node.outputs.length:0);
            node.size = [280, Math.max(30 + (Math.max(primitives.length, ioCount) * 24) + 20, 80)];
            graphInstance.add(node);
            nodeRegistry[title] = node;

            if (parentNode && connectionSlot !== null) parentNode.connect(connectionSlot, node, 0);
            childrenToConnect.forEach(child => { if (child.data && typeof child.data === 'object') buildNode(child.data, child.title, node, child.slot, child.sourceKey); });
        }


        buildNode(jsonObj, "Simulation", null, null, "root");

        pendingReferences.forEach(ref => {
            var targetNode = nodeRegistry[ref.targetName];
            if (targetNode) {
                let refSlot = targetNode.outputs.findIndex(o => o.name === "Reference");
                if (refSlot !== -1) {
                    var inputSlot = ref.sourceNode.findInputSlot(ref.slotName);
                    if(inputSlot !== -1) targetNode.connect(refSlot, ref.sourceNode, inputSlot);
                }
            }
        });

        const COL_WIDTH = 450; const ROW_PAD = 40;
        function stackNodes(nodes, colIndex) {
            let currentY = 100, xPos = 100 + (colIndex * COL_WIDTH);
            nodes.forEach(node => { node.pos = [xPos, currentY]; currentY += node.size[1] + ROW_PAD; });
        }
        stackNodes(nodesByGroup["root"], 0);
        stackNodes(nodesByGroup["bodies"], 1);
        stackNodes(nodesByGroup["spacecraft"], 2);
        stackNodes(nodesByGroup["burns"], 3);
        stackNodes(nodesByGroup["other"], 4);
        graphCanvas.setZoomAndPan(0.8, [50, 50]);
    }

    function graphToJson() {
        if (!graphInstance) return null;
        var rootNode = graphInstance._nodes.find(n => n.properties && n.properties.sourceKey === "root");
        if (!rootNode) return null;

        function buildObjectFromNode(node) {
            var obj = {};
            if (!node.title.startsWith("Burn #") && !node.title.startsWith("Simulation")) obj.name = node.title;

            if (node.widgets) {
                node.widgets.forEach(w => {
                    let val = (node.properties && node.properties[w.name] !== undefined) ? node.properties[w.name] : w.value;
                    obj[w.name] = (w.type === "number" || typeof val === 'number') ? Number(val) : val;
                });
            }

            if (node.inputs) {
                node.inputs.forEach(input => {
                    if (input.type === "reference") {
                        if (input.link !== null) {
                            var link = graphInstance.links[input.link];
                            if (link) {
                                var targetNode = graphInstance.getNodeById(link.origin_id);
                                if (targetNode) obj[input.name] = targetNode.title;
                            }
                        } else { obj[input.name] = ""; }
                    }
                });
            }

            if (node.outputs) {
                node.outputs.forEach((output) => {
                    if (output.name === "Reference") return;
                    var connectedNodes = [];
                    if (output.links) {
                        output.links.forEach(linkId => {
                            var link = graphInstance.links[linkId];
                            if (link && link.target_slot === 0) {
                                var childNode = graphInstance.getNodeById(link.target_id);
                                if (childNode) connectedNodes.push(childNode);
                            }
                        });
                    }
                    connectedNodes.sort((a,b) => a.pos[1] - b.pos[1]);
                    var childObjects = connectedNodes.map(n => buildObjectFromNode(n));
                    if (output.type === "array") { obj[output.name] = childObjects; }
                    else if (output.type === "object") { obj[output.name] = childObjects.length ? childObjects[0] : null; }
                });
            }
            return obj;
        }
        return buildObjectFromNode(rootNode);
    }

    function switchView(view) {
        if(currentView === view) return;
        if(currentView === 'json') {
            try { var val = monacoInstance.getValue(); var parsed = JSON.parse(val); jsonData = parsed; } catch(e) { alert("JSON Syntax Error: "+e.message); return; }
            try {
                if(!graphInstance) initLiteGraph();
                var currentJsonStr = JSON.stringify(jsonData);
                if (currentJsonStr !== lastRenderedJsonString) { jsonToGraph(jsonData); lastRenderedJsonString = currentJsonStr; }
            } catch(e) { console.error("Graph Error", e); }
        } else {
            var obj = graphToJson();
            if (obj) { jsonData = obj; var str = JSON.stringify(jsonData, null, 2); monacoInstance.setValue(str); lastRenderedJsonString = str; }
        }
        currentView = view;
        document.getElementById('btn-view-json').classList.toggle('active', view==='json');
        document.getElementById('btn-view-graph').classList.toggle('active', view==='graph');
        if(view === 'graph') {
            document.getElementById('monaco-editor').style.visibility = 'hidden';
            document.getElementById('graph-canvas').style.visibility = 'visible';
            if(graphCanvas) graphCanvas.resize();
        } else {
            document.getElementById('monaco-editor').style.visibility = 'visible';
            document.getElementById('graph-canvas').style.visibility = 'hidden';
        }
    }

    // --- MAIN ---
    function openEditor(){
        if(!runtimeInit){alert("Wait loading.");return}
        if(!Module.FS){alert("No FS.");return}
        emscriptenCanvas.style.pointerEvents = "none";
        emscriptenCanvas.blur();
        loadFile();
        modal.style.display="flex";
        requestAnimationFrame(function(){modal.classList.add("show")});
        setTimeout(function(){
            if(currentView==='json') monacoInstance.focus();
            refreshSidebar();
        },400)
    }
    function closeEditor(){
        modal.classList.remove("show");
        setTimeout(function(){
            modal.style.display="none";
            emscriptenCanvas.style.pointerEvents = "auto";
            emscriptenCanvas.focus();
        },400)
    }
    function handleBackdrop(e){if(e.target===modal)closeEditor()}

    function saveData(){
        if(currentView === 'json') { try { jsonData = JSON.parse(monacoInstance.getValue()); } catch(e) { alert("Invalid JSON"); return; } }
        else { var obj = graphToJson(); if(obj) jsonData = obj; }
        try{ Module.FS.writeFile(FILE_PATH, JSON.stringify(jsonData, null, 2)); console.log("Saved to FS"); closeEditor(); }catch(e){ alert("Save error: "+e.message) }
    }
    function saveAndReload(){
        saveData();
        console.log("Reloading...");
        emscriptenCanvas.focus();
        setTimeout(function(){
            var cmdString = "p\nreset\nload\nr\n";
            var index = 0;
            function typeChar() {
                if (index >= cmdString.length) return;
                var charStr = cmdString[index];
                var keyCode = charStr.charCodeAt(0);
                if (charStr === '\n') keyCode = 13;
                var down = new KeyboardEvent('keydown', { key: charStr==='\n'?'Enter':charStr, code: charStr==='\n'?'Enter':'Key'+charStr.toUpperCase(), keyCode: keyCode, which: keyCode, bubbles: true, cancelable: true });
                emscriptenCanvas.dispatchEvent(down);
                var press = new KeyboardEvent('keypress', { key: charStr==='\n'?'Enter':charStr, keyCode: keyCode, charCode: keyCode, which: keyCode, bubbles: true, cancelable: true });
                emscriptenCanvas.dispatchEvent(press);
                setTimeout(function(){
                    var up = new KeyboardEvent('keyup', { key: charStr==='\n'?'Enter':charStr, code: charStr==='\n'?'Enter':'Key'+charStr.toUpperCase(), keyCode: keyCode, which: keyCode, bubbles: true, cancelable: true });
                    emscriptenCanvas.dispatchEvent(up);
                    index++;
                    setTimeout(typeChar, 16);
                }, 10);
            }
            typeChar();
        }, 16);
    }

    // --- SIDEBAR (Tree) ---
    function buildTree(obj,path){
        var tree=[];
        if(Array.isArray(obj)){
            obj.forEach(function(item,idx){
                var currPath=path.concat(idx);
                tree.push({label:"["+idx+"]",path:currPath,line:findLine(currPath), children:typeof item==="object"&&item!==null?buildTree(item,currPath):[]})
            })
        }else if(typeof obj==="object"&&obj!==null){
            Object.keys(obj).forEach(function(key){
                var currPath=path.concat(key),val=obj[key],leaf=typeof val!=="object"||val===null;
                tree.push({label:key,path:currPath,line:findLine(currPath),isLeaf:leaf, children:!leaf?buildTree(val,currPath):[]})
            })
        }
        return tree
    }
    function findLine(path){
        if(!monacoInstance)return 1;
        var content=monacoInstance.getValue(),lines=content.split("\n");
        var key=path[path.length-1],searchStr='"'+key+'"',matches=[],i=0;
        for(i=0;i<lines.length;i++) if(lines[i].includes(searchStr)) matches.push(i+1);
        var parentArrayIdx = typeof path[path.length-2]==="number" ? path[path.length-2] : 0;
        return matches[parentArrayIdx] || matches[0] || 1;
    }
    function renderTree(nodes,parent,depth){
        depth=depth||0;
        nodes.forEach(function(node){
            var el=document.createElement("div");
            el.className="tree-node";
            el.style.paddingLeft=(depth*8+4)+"px";
            if(node.children&&node.children.length){
                el.classList.add("collapsed");
                el.textContent=node.label;el.title=node.label;
                var childContainer=document.createElement("div");
                childContainer.className="tree-children hidden";
                el.onclick=function(e){
                    e.stopPropagation();
                    if(el.classList.contains("expanded")){ el.classList.remove("expanded");el.classList.add("collapsed"); childContainer.classList.add("hidden") }
                    else{ el.classList.remove("collapsed");el.classList.add("expanded"); childContainer.classList.remove("hidden") }
                };
                parent.appendChild(el);renderTree(node.children,childContainer,depth+1);parent.appendChild(childContainer)
            }else{
                el.classList.add("leaf");el.textContent=node.label;el.title=node.label;
                el.onclick=function(e){ e.stopPropagation(); jumpToTarget(node); document.querySelectorAll(".tree-node").forEach(function(n){n.classList.remove("active")}); el.classList.add("active") };
                parent.appendChild(el)
            }
        })
    }
    function jumpToTarget(node){
        if(currentView === 'json') { monacoInstance.revealLineInCenter(node.line); monacoInstance.setPosition({lineNumber:node.line,column:1}); monacoInstance.focus(); }
        else { if(!graphInstance) return; var label = node.path[node.path.length-1]; var found = graphInstance._nodes.find(n => n.title.includes(label)); if(found) { graphCanvas.centerOnNode(found); graphCanvas.selectNode(found); } }
    }
    function refreshSidebar(){
        var sb=document.getElementById("tree-sidebar");sb.innerHTML="";
        var source = (currentView==='json' && monacoInstance) ? JSON.parse(monacoInstance.getValue()) : jsonData;
        try{ renderTree(buildTree(source,[]),sb); }catch(e){ sb.innerHTML='<div class="tree-node" style="color:#f84;">Invalid Data</div>'; }
    }
    function loadFile(){
        if(!Module.FS){console.warn("FS missing");return}
        try{
            var content=Module.FS.readFile(FILE_PATH,{encoding:"utf8"});
            try{ jsonData=JSON.parse(content); var fmt=JSON.stringify(jsonData,null,2); monacoInstance&&(monacoInstance.setValue(fmt),refreshSidebar()) }
            catch(e){ monacoInstance&&monacoInstance.setValue(content) }
        }catch(e){ monacoInstance&&monacoInstance.setValue('{\n  "error": "File not found"\n}') }
    }

    // --- EMSCRIPTEN ---
    var Module={
        print:function(t){console.log(t)},
        printErr:function(t){console.error(t)},
        canvas:(function(){
            var c=document.getElementById("canvas");
            c.addEventListener("webglcontextlost",function(e){alert("Context lost");e.preventDefault()},!1);
            c.addEventListener("click", function(){ c.focus(); }); // Click focuses
            return c
        })(),
        onRuntimeInitialized:function(){
            runtimeInit=!0;
            // Best effort auto-focus
            setTimeout(function(){
                emscriptenCanvas.focus();
                if(document.activeElement !== emscriptenCanvas) console.warn("Auto-focus blocked.");
            }, 500);
            setTimeout(loadFile,100)
        },
        setStatus:function(t){
            if(!Module.setStatus.last)Module.setStatus.last={time:Date.now(),text:""};
            if(t===Module.setStatus.last.text)return;
            var m=t.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),now=Date.now();
            if(m&&now-Module.setStatus.last.time<30)return;
            Module.setStatus.last.time=now;Module.setStatus.last.text=t;
            if(m){t=m[1];spinnerElem.hidden=!1;topOverlay.style.opacity="1"}
            else if(!t){spinnerElem.style.display="none";setTimeout(function(){if(statusElem.innerHTML==="")topOverlay.style.opacity="0"},3000)}
            statusElem.innerHTML=t
        },
        monitorRunDependencies:function(l){
            Module.setStatus(l?"Preparing... ("+l+")":"All downloads complete.")
        }
    };
    Module.setStatus("Downloading...");
    window.onerror=function(e){Module.setStatus("JS Exception");spinnerElem.style.display="none"};
    initMonaco();
</script>
<script async src="OrbitSimulation.js"></script>
</body>
</html>
